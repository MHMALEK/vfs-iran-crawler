(()=>{"use strict";var t={394:e=>{e.exports=require("@infosimples/node_two_captcha")},455:e=>{e.exports=require("compression")},582:e=>{e.exports=require("cors")},185:e=>{e.exports=require("mongoose")},311:e=>{e.exports=require("node-cron")},828:e=>{e.exports=require("puppeteer-extra")},199:e=>{e.exports=require("puppeteer-extra-plugin-stealth")},893:e=>{e.exports=require("request-promise")},745:e=>{e.exports=require("rollbar")},807:e=>{e.exports=require("user-agents")}},a={};function o(e){var s=a[e];if(void 0!==s)return s.exports;var n=a[e]={exports:{}};return t[e](n,n.exports,o),n.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s={};(()=>{o.d(s,{io:()=>z});const t=require("dotenv"),a=require("express");var n=o.n(a);const r=require("helmet");var c=o.n(r);const i=o(185),l=new i.Schema({time:{type:String,unique:!1},lastUpdated:{type:Date,unique:!0}}),d=i.model("time",l),u=require("axios");var p=o.n(u),w=o(807),m=o.n(w);o(893);const h=new(o(807));console.log("production","process.env.NODE_ENV"),console.log(";randomUserAgent",h.data.userAgent);const g={headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]},E=o(828),y=o(199);E.use(y());const T=async({headless:e,args:t,useProxy:a=!1}=g)=>{let o;return o=a?await(async({})=>{const e=await puppeteer.launch({...options,args:[...options.args,"--proxy-server=http://p.webshare.io:80"]}),t=await e.newPage();return await t.authenticate({username:"jkwivzej-rotate",password:"yf18u54hfjfx"}),e})({headless:!0,args:t}):await E.launch({headless:!0,args:t}),o},f=async e=>await e.waitForXPath('//*[contains(text(), "Your estimated wait time")]',{timeout:1e4}).then((async()=>{if(null!==queueText)return await queueText.evaluate((e=>e.innerHTML))})).catch((e=>new Error)),v=o(394),A=async e=>{try{return await e.$("#logoutForm  > a > span"),await e.click("#logoutForm  > a > span"),!1}catch{return!0}},O=async e=>{const t=(new(m())).toString();await e.setUserAgent(t)},_={GO_TO_LOGIN_PAGE:{id:0,label:"در حال ورود به وبسایت ",desc:"ما در حال باز کردن سایت VFS گلوبال هستیم... لطفا مرورگر رو نبنید و منتظر اتمام فرآیند باشید.",succesfull:!1},GET_CAPTCHA:{id:1,label:"در حال ذخیره سازی تصویر کپچا",desc:"ما داریم تصویر کپچا رو استخراج میکنیم تا بتونیم اونو حل کنیم و فرآیند ورود رو انجام بدیم.",succesfull:!1},RESOLVE_CAPTCHA:{id:2,label:"حل کپچا",desc:"تصویر کپچا در حال حل شدن است...",succesfull:!1},ENTER_LOGIN_DETAILS:{id:3,label:"وارد کردن اطلاعات ورود",desc:"ما در حال وارد کردن اطلاعات ورود و ورود به ناحیه کاربری در وبسایت ٰVFS هستیم.",succesfull:!1},LOGIN_ACTION:{id:4,label:"ورود به وبسایت VFS با موفقیت انجام شد!",desc:"ما حالا میتونیم اطلاعات قرار ملاقات رو از وبسایت پیدا کنیم.",succesfull:!1},SELECT_SERVICE:{id:5,label:"انتخاب سرویس ثبت قرار ملاقات",desc:"ما سرویس ثبت قرار ملاقات رو انتخاب میکنیم.",succesfull:!1},SELECT_LOCATION:{id:6,label:"انتخاب محل",desc:"ما دفتر تهران رو برای این قرار انتخاب میکنیم.",succesfull:!1},SELECT_APPOINTMENT_TYPE:{id:7,label:"انتخاب سرویس",desc:"ما سرویس ملاقات خانواده و دوستان رو انتخاب میکنیم.",succesfull:!1},GET_SOONEST_DATA:{id:8,label:"در حال ارسال درخواست قرار ملاقات",desc:"ما اطلاعات قرار ملاقات رو دریافت می‌کنیم",succesfull:!1},LOGOUT_ACTION:{id:9,label:"خروج از سیستم",succesfull:!1}},C=async()=>{const t=await T();console.log("sadsa",t);const a=await t.newPage();let o;console.log("page",t),await a.setCacheEnabled(!1),await O(a),a.setDefaultNavigationTimeout(18e4),console.log("page",t);try{if(await(async e=>{try{return await e.goto("https://row7.vfsglobal.com/Global-Appointment/Account/RegisteredLogin?q=shSA0YnE4pLF9Xzwon/x/MI24mBrB3J1rBC1vdDKa5IQdrJXKYTs+DdVJBpH9l4l7y9kr9wkS1P1QdJpp0GPog==",{waitUntil:"load",timeout:0})}catch(e){console.log("vvvvv",e)}})(a),await(async e=>f().then((()=>!0)).catch((()=>!1)))()){const t=f();throw _.GO_TO_LOGIN_PAGE.succesfull=!1,_.ENTER_LOGIN_DETAILS.succesfull=!1,z.emit("errorHappend",e),z.emit("newUpdate",_),new Error(t)}_.GO_TO_LOGIN_PAGE.succesfull=!0,z.emit("newUpdate",_);try{o=await(async e=>{const t=await(async e=>{await e.waitForSelector("#CaptchaImage",{timeout:18e4});const t=await e.$("#CaptchaImage");return await t.screenshot({encoding:"base64"})})(e);console.log("99999",t);const a=await(async e=>{const t=new v("0e819916b2290052cd066c68014a4282",{timeout:6e4,polling:5e3,throwErrors:!1});return(await t.decode({base64:e})).text})(t);return console.log("100000",a),a})(a),_.RESOLVE_CAPTCHA.succesfull=!0,_.GET_CAPTCHA.succesfull=!0,z.emit("newUpdate",_)}catch(e){console.log("asdasdasdasdads",e),_.GET_CAPTCHA.succesfull=!1,_.RESOLVE_CAPTCHA.succesfull=!1,z.emit("newUpdate",_),z.emit("errorHappend",e)}try{await(async(e,t)=>{function a(e){return e[Math.floor(Math.random()*e.length)]}let o;const s=await p().get("http://188.166.73.6:3008/users/verified");console.log("ssdasdasdasdsadsad",s),s.data.length>0&&(console.log("asdsadsadasdasdsad"),o=a(s.data).data.username,console.log("asdsadsadasdasdsad",o,a(s.data))),await e.type("#EmailId",o||"mhos.malek@gmail.com"),await e.type("#Password","74UKzg5oI!%8"),await e.type("#CaptchaInputText",t.toUpperCase())})(a,o),_.ENTER_LOGIN_DETAILS=!0,z.emit("newUpdate",_)}catch(e){_.ENTER_LOGIN_DETAILS=!1,z.emit("newUpdate",_),z.emit("errorHappend",e)}try{await Promise.all([a.click("#btnSubmit"),a.waitForNavigation({waitUntil:"networkidle2"})]),_.LOGIN_ACTION.succesfull=!0,z.emit("newUpdate",_)}catch(e){_.LOGIN_ACTION.succesfull=!1,z.emit("newUpdate",_),z.emit("errorHappend",e)}(async t=>{const a=await(void 0).$("#ApplicantListForm > div.validation-summary-errors > ul > li");if(a){const t=await a.evaluate((e=>e.textContent));throw _.LOGIN_ACTION.succesfull=!1,z.emit("newUpdate",_),z.emit("errorHappend",e),new Error(t)}})();try{await(async e=>{try{const t=await(async e=>{try{return await e.$("#Accordion1 > div > div.AccordionPanelContent > div > ul > li:nth-child(2) > a")}catch(e){throw new Error(e)}})(e);return await Promise.all([t.click(),e.waitForNavigation({waitUntil:"networkidle2"})])}catch(e){throw new Error(e)}})(a),_.SELECT_SERVICE.succesfull=!0,z.emit("newUpdate",_)}catch(e){_.SELECT_SERVICE.succesfull=!1,z.emit("newUpdate",_),z.emit("errorHappend",e)}try{await(async e=>{try{return await e.select("select[name='LocationId']","220")}catch(e){throw new Error(e)}})(a),_.SELECT_LOCATION.succesfull=!0,z.emit("newUpdate",_)}catch(e){_.SELECT_LOCATION.succesfull=!1,z.emit("newUpdate",_),z.emit("errorHappend",e)}try{await(async e=>{try{return await e.select("select[name='VisaCategoryId']","4887")}catch(e){throw new Error(e)}})(a),_.SELECT_APPOINTMENT_TYPE.succesfull=!0,z.emit("newUpdate",_)}catch(e){_.SELECT_APPOINTMENT_TYPE.succesfull=!1,z.emit("newUpdate",_),z.emit("errorHappend",e)}let s;try{const e=await((e,t="Account/CheckSeatAllotment")=>new Promise(((a,o)=>{try{e.on("response",(async e=>{if(e.request().url().includes(t)){const t=await e.json();return JSON.stringify(t).includes("no seat")?a(!1):a(!0)}}))}catch(e){return o(e)}})))(a);e&&(s=await(async e=>await e.waitForXPath("/html/body/div[2]/div[1]/div[3]/div[3]/form/div[1]/div[2]/div[7]/div[6]/div/table/thead/tr[2]/td[1]/label[2]",{timeout:1e4}).then((async e=>{if(console.log("asdsadsad",e),null!==e){const t=await e.evaluate((e=>e.innerHTML));return console.log("appointmetntTimeText",t),t}})).catch((e=>new Error)))(a),console.log("time",s),_.GET_SOONEST_DATA.succesfull=!0,z.emit("newUpdate",_))}catch(e){_.GET_SOONEST_DATA.succesfull=!1,z.emit("newUpdate",_)}return await A(a),_.LOGOUT_ACTION.succesfull=!0,z.emit("newUpdate",_),await t.close(),s}catch(e){throw await A(a),_.LOGOUT_ACTION.succesfull=!0,z.emit("newUpdate",_),z.emit("errorHappend",e),await t.close(),console.log("eeeeee",e),new Error(e)}},I=async(e,t,a)=>{try{const e=await(async()=>{const e=await d.findOne().sort({_id:-1});return console.log("asd",e),e})();t.send(e)}catch(e){throw a(e),new Error(e)}},S=async(e,t,a)=>{console.log("checkAppointmentsController");try{const e=await C();t.json({soonestTime:e})}catch(e){throw a(e),new Error(e)}},b=o(745),N=require("socket.io"),L=o(185),x=o(311),U={expression:"0 * * * *",callBack:()=>console.log("executed on a schedule!")},P=require("grammy"),G=o(185),q=new G.Schema({chatId:{type:Number,unique:!0}}),k=G.model("telegram",q),H=async e=>{const t=new k({chatId:e});return await t.save((function(e){e&&console.log(e),console.log("Inserted document into the collection")}))},D=new P.Bot("6225139319:AAEtFdJlbuS9Dp4bvoJzxPjDOCzIMXwd1AU"),F=(({callBack:e,expression:t}=U)=>{const a=x.schedule(t,e);return a.start(),{start:()=>a.start(),stop:()=>a.stop}})({expression:U.expression,callBack:async()=>{try{const e=await C();(async e=>{const t=new d({time:e,lastUpdated:new Date});await t.save((function(e){e&&console.log(e),console.log("Inserted document into the collection")}))})(e),(async e=>{(await(async()=>await k.find())()).map((async t=>await D.api.sendMessage(t.chatId,e)))})(e)}catch(e){throw new Error(e)}}}),V=async(e,t,a)=>{try{t.send("this app is a simple robot to help you find and make appointment in VFS global in Iran!!!")}catch(e){throw a(e),new Error(e)}};t.config();const j=o(455);var R=o(582);const M=new b({accessToken:"a448a0ece2324e8eb5a4273565a815ee",captureUncaught:!0,captureUnhandledRejections:!0}),B=[a.json,c(),j,M.errorHandler,R];(()=>{try{const e="mongodb+srv://mhosmalek:LV8Sduyf6g3fejCd@cluster0.vvvcesp.mongodb.net/";console.log("mongoString",e),L.connect(e,{dbName:"vfs-appointments"});const t=L.connection;t.on("error",(e=>{throw console.log(e),new Error("can not connect to database")})),t.once("connected",(()=>(console.log("Database Connected"),t)))}catch(e){}})(),F.start(),(async e=>{(e=>{D.command("start",(t=>{t.reply("Welcome! This bot will check VFS appointment system and will notify about the soonest available appointment"),e(t.from.id)})),D.on("message",(e=>e.reply("Got another message!")))})(e),D.start()})(H);const{app:J,server:Y}=(()=>{const e=n()();(e=>{B.map((t=>e.use(t())))})(e),e.get("/",V),e.get("/check-appointment",S),e.get("/show-soonest",I);const t=e.listen("3007",(()=>console.log("App listening at port 3007")));return{app:e,server:t}})(),z=new N.Server(Y,{cors:{origin:"*"}});z.on("connection",(e=>{console.log(`⚡: ${e.id} user just connected!`),e.on("disconnect",(()=>{console.log("🔥: A user disconnected")}))}))})()})();