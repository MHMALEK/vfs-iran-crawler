(()=>{"use strict";var e={93:(e,t,a)=>{a.r(t),a.d(t,{captchaDefaultType:()=>o,default:()=>n});const o="ImageToTextTask",n={CREATE_TASK:"createTask",GET_TASK:"getTaskResult"}},167:e=>{e.exports=require("axios")},455:e=>{e.exports=require("compression")},185:e=>{e.exports=require("mongoose")},311:e=>{e.exports=require("node-cron")},159:e=>{e.exports=require("node-telegram-bot-api")},828:e=>{e.exports=require("puppeteer-extra")},199:e=>{e.exports=require("puppeteer-extra-plugin-stealth")},745:e=>{e.exports=require("rollbar")},807:e=>{e.exports=require("user-agents")}},t={};function a(o){var n=t[o];if(void 0!==n)return n.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,a),r.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var o in t)a.o(t,o)&&!a.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=require("dotenv"),t=require("express");var o=a.n(t);const n=require("helmet");var r=a.n(n);const s=new(a(807))({deviceCategory:"desktop",platform:"Linux x86_64"});console.log("production","process.env.NODE_ENV"),console.log(";randomUserAgent",s.data.userAgent);const c={headless:!0,args:[s.data.userAgent||"--user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36"]},i=a(828),l=a(199);i.use(l());const u=async({headless:e,args:t}=c)=>await i.launch({headless:e,args:t}),w=async e=>await e.waitForXPath('//*[contains(text(), "Your estimated wait time")]',{timeout:1e4}).then((async()=>{if(null!==queueText)return await queueText.evaluate((e=>e.innerHTML))})).catch((e=>new Error)),d=a(167),{default:p,captchaDefaultType:h}=a(93),y=a(185),g=new y.Schema({chatId:{type:Number,unique:!0}}),m=y.model("user",g),b=m,x=a(159),f=(v="5239349771:AAG4DIgtPuSp7AsgZIzzHj5si2dydK2be64",console.log(v),new x(v,{polling:!0}));var v;const T=async()=>{f.isPolling()&&(await f.stopPolling(),await f.startPolling()),f.on("message",k),f.on("callback_query",A),f.onText(/\/start/,E)},E=e=>{const t=e.chat.id;f.sendMessage(t,"Please choose",{reply_markup:JSON.stringify({inline_keyboard:[[{text:"Notify me!",callback_data:"NOTIFY"}],[{text:"About Bot",callback_data:"ABOUT"}]]})})},k=e=>{console.log(e);const t=e.chat.id;_(t),E()},A=e=>{const t=e.data,a=e.message,o={chat_id:a.chat.id,message_id:a.message_id};let n;"NOTIFY"===t&&(n="You will be notified when there is a new slot available"),"ABOUT"===t&&(n="You can read more about this bot on the website"),f.editMessageText(n,o)},_=async e=>{try{await(async e=>{const t=await(async e=>await m.findOne({chatId:e}))(e);return!!t})(e)||new b({chatId:e}).save()}catch(e){throw new Error("can not save user to database")}},S=async e=>{const t=await(async()=>await m.find())();console.log("users",t,e),t.map((({chatId:t})=>f.sendMessage(t,e)))};T();const I=async()=>{const e=await u(),t=await e.newPage();try{if(await(async e=>await e.goto("https://online.vfsglobal.com/Global-Appointment/Account/RegisteredLogin?q=shSA0YnE4pLF9Xzwon/x/MI24mBrB3J1rBC1vdDKa5IQdrJXKYTs+DdVJBpH9l4l7y9kr9wkS1P1QdJpp0GPog=="))(t),await(async e=>w().then((()=>!0)).catch((()=>!1)))()){const e=w();throw new Error(e)}const e=await(async e=>{const t=await(async e=>{await e.waitForSelector("#CaptchaImage");const t=await e.$("#CaptchaImage");return await t.screenshot({path:"captcha.png",encoding:"base64"})})(e);return await(e=>new Promise((async(t,a)=>{try{const a=await(async e=>await d.post(`https://api.anycaptcha.com/${p.CREATE_TASK}`,{clientKey:"41922ef06402437ca348e785a4f6df05",task:{type:h,body:e}}).then((e=>e.data.taskId)).catch((e=>{throw new Error("ERROR_TYPES.SUBMIT_CPATCH_TO_RESOLVER_SERVER_ERROR")})))(e),o=setInterval((async()=>{const e=await(async e=>await d.post(`https://api.anycaptcha.com/${p.GET_TASK}`,{clientKey:"41922ef06402437ca348e785a4f6df05",taskId:e}).then((async e=>e.data)).catch((e=>{throw new Error(e)})))(a);"ready"===e.status&&(clearInterval(o),t(e.solution.text))}),3e3)}catch(e){a(e)}})))(t)})(t);await(async(e,t)=>{await e.type("#EmailId","mhos.malek@gmail.com"),await e.type("#Password","w6#rtCpbzkUw"),await e.type("#CaptchaInputText",t.toUpperCase())})(t,e),await Promise.all([t.click("#btnSubmit"),t.waitForNavigation({waitUntil:"networkidle2"})]),(async e=>{const t=await(void 0).$("#ApplicantListForm > div.validation-summary-errors > ul > li");if(t){const e=await t.evaluate((e=>e.textContent));throw new Error(e)}})(),await(async e=>{try{const t=await(async e=>{try{return await e.$("#Accordion1 > div > div.AccordionPanelContent > div > ul > li:nth-child(2) > a")}catch(e){throw new Error(e)}})(e);return await Promise.all([t.click(),e.waitForNavigation({waitUntil:"networkidle2"})])}catch(e){throw new Error(e)}})(t),await(async e=>{try{return await e.select("select[name='LocationId']","220")}catch(e){throw new Error(e)}})(t);const a=await((e,t="Account/CheckSeatAllotment")=>new Promise(((a,o)=>{try{e.on("response",(async e=>{if(e.request().url().includes(t)){const t=await e.json();return JSON.stringify(t).includes("no seat")?a(t):(console.log("responseFromEndpoint",t),a("Appointment is Availble! Get it soon!"))}}))}catch(e){return o(e)}})))(t);return await(async e=>{try{return await e.$("#logoutForm  > a > span"),await e.click("#logoutForm  > a > span"),!1}catch{return!0}})(t),a}catch(e){throw new Error(e)}},P=I,q=async(e,t,a)=>{try{const e=await P();S(e),t.send(e)}catch(e){throw a(e),new Error(e)}},O=(e,t)=>{T()},C=a(185),R=a(311),M={expression:"0 12 * * *",callBack:()=>console.log("executed on a schedule!")},B=a(745);e.config();const F=a(455),K=[t.json,r(),F];(({callBack:e,expression:t}=M)=>{const a=R.schedule(t,e);a.start()})({expression:M.expression,callBack:async()=>{try{const e=await I();S(e)}catch(e){throw console.log("malek",e),new Error(e)}}}),(()=>{const e=o()();(e=>{K.map((t=>e.use(t())))})(e),(()=>{try{const e="mongodb+srv://vfs-data-base-user:or4m4PZfozvioH7m@cluster0.ygtsbho.mongodb.net/test";C.connect(e);const t=C.connection;t.on("error",(e=>{throw console.log(e),new Error("can not connect to database")})),t.once("connected",(()=>(console.log("Database Connected"),t)))}catch(e){}})(),new B({accessToken:"a448a0ece2324e8eb5a4273565a815ee",captureUncaught:!0,captureUnhandledRejections:!0}),e.get("/",q),e.get("/start-bot",O),e.listen("8000",(()=>console.log("App listening at port 8000")))})()})()})();