(()=>{"use strict";var t={93:(t,e,a)=>{a.r(e),a.d(e,{captchaDefaultType:()=>o,default:()=>n});const o="ImageToTextTask",n={CREATE_TASK:"createTask",GET_TASK:"getTaskResult"}},167:t=>{t.exports=require("axios")},185:t=>{t.exports=require("mongoose")},311:t=>{t.exports=require("node-cron")},159:t=>{t.exports=require("node-telegram-bot-api")},828:t=>{t.exports=require("puppeteer-extra")},199:t=>{t.exports=require("puppeteer-extra-plugin-stealth")}},e={};function a(o){var n=e[o];if(void 0!==n)return n.exports;var r=e[o]={exports:{}};return t[o](r,r.exports,a),r.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var o in e)a.o(e,o)&&!a.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{const t=require("dotenv"),e=require("express");var o=a.n(e);const n=require("helmet");var r=a.n(n);const s={headless:!1,args:["--user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36"]},c=a(828),i=a(199);c.use(i());const l=async({headless:t,args:e}=s)=>await c.launch({headless:t,args:e}),u=async t=>await t.waitForXPath('//*[contains(text(), "Your estimated wait time")]',{timeout:1e4}).then((async()=>{if(null!==queueText)return await queueText.evaluate((t=>t.innerHTML))})).catch((t=>new Error)),w=a(167),{default:d,captchaDefaultType:p}=a(93),h=async t=>{try{return await t.$("#logoutForm  > a > span"),await t.click("#logoutForm  > a > span"),!1}catch{return!0}},y=async()=>{const t=await l(),e=await t.newPage();try{if(await(async t=>await t.goto("https://online.vfsglobal.com/Global-Appointment/Account/RegisteredLogin?q=shSA0YnE4pLF9Xzwon/x/MI24mBrB3J1rBC1vdDKa5IQdrJXKYTs+DdVJBpH9l4l7y9kr9wkS1P1QdJpp0GPog=="))(e),await(async t=>u().then((()=>!0)).catch((()=>!1)))()){const t=u();throw new Error(t)}const t=await(async t=>{const e=await(async t=>{await t.waitForSelector("#CaptchaImage");const e=await t.$("#CaptchaImage");return await e.screenshot({path:"captcha.png",encoding:"base64"})})(t);return await(t=>new Promise((async(e,a)=>{try{const a=await(async t=>await w.post(`https://api.anycaptcha.com/${d.CREATE_TASK}`,{clientKey:"41922ef06402437ca348e785a4f6df05",task:{type:p,body:t}}).then((t=>t.data.taskId)).catch((t=>{throw new Error("ERROR_TYPES.SUBMIT_CPATCH_TO_RESOLVER_SERVER_ERROR")})))(t),o=setInterval((async()=>{const t=await(async t=>await w.post(`https://api.anycaptcha.com/${d.GET_TASK}`,{clientKey:"41922ef06402437ca348e785a4f6df05",taskId:t}).then((async t=>t.data)).catch((t=>{throw new Error(t)})))(a);"ready"===t.status&&(clearInterval(o),e(t.solution.text))}),3e3)}catch(t){a(t)}})))(e)})(e);await(async(t,e)=>{await t.type("#EmailId","mhos.malek@gmail.com"),await t.type("#Password","w6#rtCpbzkUw"),await t.type("#CaptchaInputText",e.toUpperCase())})(e,t),await Promise.all([e.click("#btnSubmit"),e.waitForNavigation({waitUntil:"networkidle2"})]);const a=await e.$("#ApplicantListForm > div.validation-summary-errors > ul > li");if(a){const t=await a.evaluate((t=>t.textContent));throw new Error(t)}await(async t=>{try{const e=await(async t=>{try{return await t.$("#Accordion1 > div > div.AccordionPanelContent > div > ul > li:nth-child(2) > a")}catch(t){throw new Error(t)}})(t);return await Promise.all([e.click(),t.waitForNavigation({waitUntil:"networkidle2"})])}catch(t){throw new Error(t)}})(e),await(async t=>{try{return await t.select("select[name='LocationId']","220")}catch(t){throw new Error(t)}})(e);const o=await((t,e="Account/CheckSeatAllotment")=>new Promise(((a,o)=>{try{t.on("response",(async t=>{if(t.request().url().includes(e)){const e=await t.json();return JSON.stringify(e).includes("no seat")?a(e):(console.log("responseFromEndpoint",e),a("Appointment is Availble! Get it soon!"))}}))}catch(t){return o(t)}})))(e);return await h(e),o}catch(t){throw await h(e),new Error(t)}},g=y,m=async(t,e,a)=>{try{const t=await g();e.send(t)}catch(t){console.log(t)}},b=a(185),T=new b.Schema({chatId:{type:Number,unique:!0}}),f=b.model("user",T),v=f,x=new(a(159))("5239349771:AAGsVEHuyJ7NZ_DOBQeMBtaVYjrPWZhq3E4",{polling:!0}),E=t=>{const e=t.chat.id;x.sendMessage(e,"Please choose",{reply_markup:JSON.stringify({inline_keyboard:[[{text:"Notify me!",callback_data:"NOTIFY"}],[{text:"About Bot",callback_data:"ABOUT"}]]})})},k=async t=>{try{await(async t=>{const e=await(async t=>await f.findOne({chatId:t}))(t);return!!e})(t)||new v({chatId:t}).save()}catch(t){throw new Error("can not save user to database")}},A=(t,e)=>{console.log("telegramBotController")},_=a(185),S=a(311),P={expression:"0 12 * * *",callBack:()=>console.log("executed on a schedule!")},I=(t,e,a,o)=>{const n=t.statusCode||500;console.log("asdsad",t),a.status(n).json({message:t})};t.config();const O=process.env.PORT||3e3;x.on("message",(t=>{const e=t.chat.id;k(e),E()})),x.on("callback_query",(t=>{const e=t.data,a=t.message,o={chat_id:a.chat.id,message_id:a.message_id};let n;"NOTIFY"===e&&(n="You will be notified when there is a new slot available"),"ABOUT"===e&&(n="You can read more about this bot on the website"),x.editMessageText(n,o)})),x.onText(/\/start/,E),(({callBack:t,expression:e}=P)=>{const a=S.schedule(e,t);return a.start(),{start:()=>a.start(),stop:()=>a.stop}})({expression:P.expression,callBack:async()=>{try{const t=await y();sendMessageToAllUsers(t)}catch(t){throw console.log(t),new Error(t)}}}).start(),(()=>{const t=o()();t.use((0,e.json)()),t.use(r()()),t.use(I),(()=>{try{const t="mongodb+srv://vfs-data-base-user:or4m4PZfozvioH7m@cluster0.ygtsbho.mongodb.net/test";_.connect(t);const e=_.connection;e.on("error",(t=>{throw console.log(t),new Error("can not connect to database")})),e.once("connected",(()=>(console.log("Database Connected"),e)))}catch(t){}})(),t.get("/",m),t.get("/start-bot",A),t.listen(O,(()=>console.log(`App listening at port ${O}`)))})()})()})();